version: "3.3"
services:
  canis-apiserver:
    image: canis/canis
    command: "canis-apiserver start"
    ports:
      - "7778:7778"
      - "7779:7779"
    networks:
      - backend
    secrets:
      - source: canis-apiserver-config
        target: /etc/canis/canis-apiserver-config.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  canis-didcomm-issuer:
    image: canis/canis
    command: "canis-didcomm-issuer start"
    ports:
      - "7776:7776"
    networks:
      - backend
    secrets:
      - source: canis-didcomm-issuer-config
        target: /etc/canis/canis-issuer-config.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  canis-didcomm-verifier:
    image: canis/canis
    command: "canis-didcomm-verifier start"
    ports:
      - "7777:7777"
    networks:
      - backend
    secrets:
      - source: canis-didcomm-verifier-config
        target: /etc/canis/canis-didcomm-config.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  canis-didcomm-doorman:
    image: canis/canis
    command: "canis-didcomm-doorman start"
    ports:
      - "8886:8886"
    networks:
      - backend
    secrets:
      - source: canis-didcomm-doorman-config
        target: /etc/canis/canis-doorman-config.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  canis-didcomm-lb:
    image: canis/canis
    command: "canis-didcomm-lb start"
    ports:
      - "9001:9001"
      - "9003:9003"
      - "9996:9996"
    networks:
      - backend
    secrets:
      - source: canis-didcomm-lb-config
        target: /etc/canis/canis-lb-config.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  http-indy-resolver:
    image: canis/canis
    command: "http-indy-resolver start"
    ports:
      - "5544:5544"
    networks:
      - backend
    secrets:
      - source: http-indy-resolver-config
        target: /etc/canis/http-indy-resolver.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
  canis-webhook-notifier:
    image: canis/canis
    command: "canis-webhook-notifier start"
    networks:
      - backend
    secrets:
      - source: canis-webhook-notifier-config
        target: /etc/canis/canis-webhook-notifier.yml
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure

secrets:
  canis-apiserver-config:
    file: ./canis-apiserver.yaml
  canis-didcomm-issuer-config:
    file: ./canis-didcomm-issuer.yaml
  canis-didcomm-verifier-config:
    file: ./canis-didcomm-verifier.yaml
  canis-didcomm-doorman-config:
    file: ./canis-didcomm-doorman.yaml
  canis-didcomm-lb-config:
    file: ./canis-didcomm-lb.yaml
  http-indy-resolver-config:
    file: ./http-indy-resolver.yaml
  canis-webhook-notifier-config:
    file: ./canis-webhook-notifier.yaml

networks:
  backend:

volumes:
  canis_data:
  etc:
    driver: local
    driver_opts:
      type: local
      device: /data/canis
      o: bind